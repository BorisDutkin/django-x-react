{% extends 'base.html' %} 

{% block head_title %}Home{% endblock %} 

{% block content%}

<div class="row">
    <div class="col text-center">
        <h1 class="mb-4">Welcome to Tweetme 2 </h1>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-4 mx-auto col-10">
        <form id="tweet-create-form" class="form" method="POST" action="/tweets/create/">
            {% csrf_token %}
            <input type="hidden" value="/" name="next">
            <textarea required class="form-control" name="content" placeholder="Your tweet..."></textarea>
            <button type="submit" class="btn btn-primary mt-4">Tweet</button>
        </form>
    </div>
</div>

<ul class="row" id="tweets">
    loading...
</ul>

<script>       
    const list = document.getElementById('tweets');
    const form = document.getElementById('tweet-create-form');

    async function handleTweetCreateFormSubmit(e) {
        e.preventDefault();  

        const { target: form } = e;

        const formData = new FormData(form);        
        const endpoint = form.getAttribute('action');
        const method = form.getAttribute('method');  
        const csrf_token = formData.get('csrfmiddlewaretoken');                

        const response = await fetch(endpoint, {
            method,
            body: formData,
            headers: {     
                'HTTP_X_REQUESTED_WITH': 'XMLHttpRequest',                
                'X-Requested-With': 'XMLHttpRequest',                
                'X-CSRFToken': csrf_token
            },
        });

        if (response.status === 201) {
            const parsed = await response.json();
            const tweet = createTweetElement(parsed);
            list.prepend(tweet);      
            form.reset();      
        }        
    }

    form.addEventListener('submit', handleTweetCreateFormSubmit);

    loadTweets = async (el) => {
        const url = 'http://localhost:8000/tweets/';

        const response = await fetch(url, {
            method: 'get',
            headers: {            
                'Content-Type': 'application/json'
            },
        });

        const parsed = await response.json();
        const { tweets } = parsed;

        el.innerHTML = '';
        
        tweets.forEach(tweet => {            
            el.appendChild(this.createTweetElement(tweet));
        });
    }        
                    
    
    function handleLike(id, likes) {
        console.log(id, likes);
    }

    function likeButton(id, likes) {            
        const button = document.createElement('button');

        button.onclick = function() {               
            handleLike(id, likes);
        };

        button.classList.add('btn');
        button.classList.add('btn-primary');            
        button.style.display = 'block';
        button.style.margin = '10px 0 20px 0';
        button.textContent = `${likes} Likes`;

        return button;
    }

    function createTweetElement(tweet) {
        const element = document.createElement('li');                                    

        element.textContent = `id: ${tweet.id} -  ${tweet.content}`;
        element.setAttribute('id', `tweet-${tweet.id}`);
        element.classList.add('col-12');            
        element.classList.add('col-md-10');            
        element.classList.add('mx-auto');            
        element.classList.add('border');  
        element.classList.add('rounded');  
        element.classList.add('mb-4');                       
        element.classList.add('py-3');
        element.appendChild(likeButton(tweet.id, tweet.likes));
        
        return element;            
    }       

    loadTweets(list);
</script>
{% endblock %}
